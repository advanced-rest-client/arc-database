<!--
@license
Copyright 2016 The Advanced REST client authors
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-query.html">
<!--
`<arc-database>` A database component for advanced rest client

### Example
```
<arc-database></arc-database>
```

## ARC databases

### history-data
Keeps history (HAR) data. It should not be indexed since it's only to put and keep data.
At least for now. In oposite to the `history-requests` datastore it also keeps response data.

This view can be huge!

### saved-requests
Requests saved by the user.
Index on:
- url
- method
- paylaod
- headers
The name is in the object key as a:
```
url encoded name + '/' url encoded url + '/' + method
```

### legacy-projects
Legacy structure and support will be here for some time more.
There are no indexes for this object store.

### history-requests
All the requests made by the user. It does not contains response data.

Indexes on:
- time
- url
- method
Object key is:
```
url encoded url + '/' + method + '/' + Date.now()
```

### external-requests
Requests saved in the external datastores (Drive).

Indexes on:
- time
- url
- method
Object key is:
```
url encoded name + '/' url encoded url + '/' + method
```

### cookies
Cookies store for socket transport
Main key is
```
domain + '/' + url encoded i.name + '/' + url encoded i.path;
```

### auth-data
Saved credentials for socket transport
Main key:
```
type + '/' + url encoded i.url;
```

### variables
User defined variables.
Keys will be defined later.

@group Logic Elements
@element arc-database
@demo demo/index.html Requests datastore
@demo demo/har-data.html HarData datastore
-->
<dom-module id="arc-database">
  <template>
    <style>
     :host {
      display: none;
    }
    </style>
    <app-pouchdb-conflict-resolution strategy="lastWriteWins"></app-pouchdb-conflict-resolution>
    <template is="dom-repeat" items="[[indexes]]" index-as="index">
      <app-pouchdb-index adapter="[[adapter]]" db-name="[[store]]" fields="[[item.fields]]" name="[[item.name]]"></app-pouchdb-index>
    </template>
    <app-pouchdb-query db="{{db}}" id="query" adapter="[[adapter]]" db-name="[[store]]" selector="[[querySelector]]" fields="[[queryFields]]" sort="[[querySort]]" data="{{queryResult}}" limit="[[queryLimit]]"></app-pouchdb-query>
  </template>
  <script>
  (function() {
    'use strict';

    class ArcDatabase {

      beforeRegister() {
        this.is = 'arc-database';
        this._eventTarget = null;
        this.properties = {
          db: {
            type: Object,
            notify: true
          },
          /**
           * Name of the storage to initialize
           */
          store: String,
          // Adapter to use. Indexeddb by default.
          adapter: {
            type: String,
            value: 'idb'
          },
          /**
           * The indexes to be set for the datastore.
           * Indexes will change depending on the store name. If the store name is unknown then
           * `error` event will be fired.
           */
          indexes: {
            type: Array,
            readOnly: true
          },
          // A selector passed to `<app-pouchdb-query>.selector`
          querySelector: String,
          // An array of fields passed to `<app-pouchdb-query>.fields`
          queryFields: Array,
          // An array of fields passed to `<app-pouchdb-query>.sort`
          querySort: Array,
          // The results of the query, if any.
          queryResult: {
            type: Array,
            notify: true
          },
          /**
           * The maximum number of documents that can be returned. The default (0) specifies
           * no limit.
           */
          queryLimit: {
            type: Number,
            value: 0
          },
          /**
           * The number of documents to skip before returning results that match the query.
           * In other words, the offset from the beginning of the of the result set to start at.
           */
          querySkip: {
            type: Number,
            value: 0
          }
        };
      }

      get observers() {
        return [
          '_storeChanged(store)',
          '_queryResultChanged(queryResult.*)'
        ];
      }

      get savedRequests() {
        return [{
          'fields': ['name', 'method', 'url', 'legacyProject']
        }];
      }

      get historyRequests() {
        return [{
          'fields': ['method', 'url', 'legacyProject']
        }];
      }

      get environments() {
        return [{
          'fields': ['enabled']
        }];
      }

      attached() {
        this._eventTarget = Polymer.dom(this).host || document;
        this.listen(this._eventTarget, 'arc-database-query', '_databaseQuery');
        this.listen(this._eventTarget, 'arc-database-insert', '_databaseInsert');
      }

      detached() {
        this.unlisten(this._eventTarget, 'arc-database-query', '_databaseQuery');
        this.unlisten(this._eventTarget, 'arc-database-insert', '_databaseInsert');
      }

      _databaseQuery(e) {
        var detail = e.detail;
        if (!detail.store || !this.store || this.store !== detail.store) {
          return;
        }
        e.stopImmediatePropagation();
        e.preventDefault();
        if (detail.selector) {
          this.set('querySelector', detail.selector);
        }
        if (detail.fields) {
          this.set('queryFields', detail.fields);
        }
        if (detail.sort) {
          this.set('querySort', detail.sort);
        }
        if (detail.limit) {
          this.set('queryLimit', detail.limit);
        }
        if (detail.skip) {
          this.set('querySkip', detail.skip);
        }
        detail.result = new Promise((resolve, reject) => {
          this.__eventQueryResolver = resolve;
          this.__eventQueryRejected = reject;
        });
        this.query();
      }

      _databaseInsert(event) {
        var detail = event.detail;
        if (!detail.store || !this.store || this.store !== detail.store) {
          return;
        }
        event.stopImmediatePropagation();
        event.preventDefault();
        detail.result = this._eventInsert(detail.docs);
      }

      _eventInsert(docs) {
        if (docs instanceof Array) {
          return this.db.bulkDocs(docs);
        }
        return this.db.put(docs);
      }

      _storeChanged(store) {
        if (!store) {
          this._setIndexes([]);
          return;
        }
        var indexes;
        switch (store) {
          case 'history-data': indexes = []; break;
          case 'saved-requests': indexes = this.savedRequests; break;
          case 'legacy-projects': indexes = []; break;
          case 'logs': indexes = []; break;
          case 'history-requests': break;
          case 'external-requests': indexes = this.savedRequests; break;
          case 'auth-data': indexes = []; break;
          case 'cookies': indexes = []; break;
          case 'variables': indexes = []; break;
          default:
            if (!(store in this)) {
              return this.fire('error', new Error(`The store ${store} is unknown.`));
            }
            indexes = this[store];
        }

        if (indexes) {
          this._setIndexes(indexes);
        } else {
          return this.fire('error', new Error(`Indexes for ${store} is invalid.`));
        }
      }

      _queryResultChanged() {
        if (this.__eventQueryResolver) {
          this.__eventQueryResolver(this.queryResult);
          this.__eventQueryResolver = undefined;
          this.__eventQueryRejected = undefined;
        }
        this.fire('query-result', {
          value: this.queryResult
        });
      }

      query() {
        this.$.query.refresh();
      }
    }
    Polymer(ArcDatabase);
  })();
  </script>
</dom-module>
